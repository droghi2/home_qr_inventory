{% extends "base.html" %}
{% block content %}
{% set back_href = '/' %}
{% if node['parent_id'] %}
  {% set back_href = '/node/' ~ node['parent_id'] %}
{% endif %}

<div class="section header-row-outside">
  <a class="back-rail" href="{{ back_href }}" aria-label="Back" title="Back">
    <!-- crisp chevron icon -->
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M15 18L9 12l6-6" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </a>

  <div class="card">
    <div class="card-pad">
      {# ...keep your existing header content here (breadcrumb/title/trash/note)... #}


      {% if node['type'] in ['Cabinet','Wardrobe'] %}
        <!-- Top-level title + trash -->
        <div class="row titlebar" style="justify-content:space-between; align-items:center; margin-top:.3rem;">
          <h2 style="margin:.3rem 0 0 0">{{ node['name'] }}</h2>
          <form class="no-shrink" action="/node/{{ node['id'] }}/delete" method="post"
                data-ntype="{{ node['type'] }}"
                onsubmit="return confirmNodeDelete(this);">
            <button class="icon-btn danger" type="submit" aria-label="Delete {{ node['type'] }}" title="Delete {{ node['type'] }}">üóëÔ∏è</button>
          </form>
        </div>

      {% elif node['type'] in ['Shelf','Drawer'] %}
        <!-- Shelf/Drawer title + trash -->
         {% if node['type'] in ['Shelf','Drawer'] and parent %}
          <div class="badges breadcrumb-inline">
            <!-- Parent: Wardrobe/Cabinet -->
            <a class="link crumb" href="/node/{{ parent['id'] }}">
              {{ parent['type'] }} ‚Äî {{ parent['name'] }}
            </a>
            {% if parent['note'] %}
              <span class="sep">‚Ä¢</span>
              <span class="note" title="{{ parent['note'] }}">{{ parent['note'] }}</span>
            {% endif %}
            <span class="sep">‚Ä∫</span>
            <!-- Current node type -->
            <span class="pill">{{ node['type'] }}</span>
          </div>
        {% else %}
          <!-- Top-level fallback: show its own type/name inline -->
          <div class="badges breadcrumb-inline">
            <span class="crumb">{{ node['type'] }} ‚Äî {{ node['name'] }}</span>
            {% if node['note'] %}
              <span class="sep">‚Ä¢</span>
              <span class="note" title="{{ node['note'] }}">{{ node['note'] }}</span>
            {% endif %}
          </div>
        {% endif %}

        <div class="row titlebar" style="justify-content:space-between; align-items:center; margin-top:.3rem;">
          <h2 style="margin:.3rem 0 0 0">{{ node['name'] }}</h2>
          <form class="no-shrink" action="/node/{{ node['id'] }}/delete" method="post"
                data-ntype="{{ node['type'] }}"
                onsubmit="return confirmNodeDelete(this);">
            <button class="icon-btn danger" type="submit" aria-label="Delete {{ node['type'] }}" title="Delete {{ node['type'] }}">üóëÔ∏è</button>
          </form>
        </div>

      {% else %}
        <h2 style="margin:.3rem 0 0 0">{{ node['name'] }}</h2>
      {% endif %}



      {% if node['note'] %}<div class="muted">{{ node['note'] }}</div>{% endif %}
    </div>
  </div>
</div>

{% if node['type'] in ['Cabinet','Wardrobe'] %}

  <!-- Top-level: compact grid + filter + show more; inline + buttons -->
  <div class="section">
    <div class="row toolbar-mini" style="justify-content:space-between;">
      <div class="kicker">Shelves & drawers</div>
      <button class="icon-btn plus" id="addNodeBtn" title="Add shelf / drawer">+</button>
    </div>


    <!-- Shelves -->
    {% set shelves = subs | selectattr('type','equalto','Shelf') | list %}
    <div class="subsection">
      <div class="row" style="justify-content:space-between; align-items:center; margin:.4rem 0 .6rem 0;">
        <div class="row" style="gap:8px; align-items:center">
          <div class="kicker">Shelves</div>
        </div>
        {% if shelves|length > 8 %}
          <button class="ghost tiny" id="toggleShelves">Show more</button>
        {% endif %}
      </div>

      <ul class="cards subgrid" id="shelvesGrid">
        {% for s in shelves %}
        <li class="card subcard {% if loop.index0 >= 8 %}hidden-shelf{% endif %}" data-name="{{ s['name']|lower }}">
          <div class="card-pad">
            <!-- Row 1: name as link -->
            <h3 style="margin:.2rem 0 0 0">
              <a class="link" href="/node/{{ s['id'] }}">{{ s['name'] }}</a>
              <span class="pill">Shelf</span>
            </h3>
            {% if s['note'] %}<div class="muted small-note">{{ s['note'] }}</div>{% endif %}

            <!-- Row 2: chips (hide zeros) -->
            {% set b = bytype.get(s['id'], {}) if bytype else {} %}
            {% set bsum = (b.get('Box', 0) + b.get('Organizator', 0) + b.get('InPlace', 0)) %}
            <div class="badges" style="margin-top:.35rem">
              {% if b.get('Box', 0) %}<span class="chip">Box: {{ b.get('Box') }}</span>{% endif %}
              {% if b.get('Organizator', 0) %}<span class="chip">Org: {{ b.get('Organizator') }}</span>{% endif %}
              {% if b.get('InPlace', 0) %}<span class="chip">IP: {{ b.get('InPlace') }}</span>{% endif %}
              {% if not bsum %}<span class="muted">No containers</span>{% endif %}
            </div>
          </div>

        </li>

        {% endfor %}
        {% if shelves|length == 0 %}
          <li class="empty">No shelves</li>
        {% endif %}
      </ul>
    </div>


    <!-- Drawers -->
    {% set drawers = subs | selectattr('type','equalto','Drawer') | list %}
    <div class="subsection" style="margin-top:1rem;">
      <div class="row" style="justify-content:space-between; align-items:center; margin:.4rem 0 .6rem 0;">
        <div class="row" style="gap:8px; align-items:center">
          <div class="kicker">Drawers</div>
        </div>
        {% if drawers|length > 8 %}
          <button class="ghost tiny" id="toggleDrawers">Show more</button>
        {% endif %}
      </div>

      <ul class="cards subgrid" id="drawersGrid">
        {% for d in drawers %}
        <li class="card subcard {% if loop.index0 >= 8 %}hidden-drawer{% endif %}" data-name="{{ d['name']|lower }}">
          <div class="card-pad">
            <!-- Row 1: name as link -->
            <h3 style="margin:.2rem 0 0 0">
              <a class="link" href="/node/{{ d['id'] }}">{{ d['name'] }}</a>
              <span class="pill">Drawer</span>
            </h3>
            {% if d['note'] %}<div class="muted small-note">{{ d['note'] }}</div>{% endif %}

            <!-- Row 2: chips (hide zeros) -->
            {% set b = bytype.get(d['id'], {}) if bytype else {} %}
            {% set bsum = (b.get('Box', 0) + b.get('Organizator', 0) + b.get('InPlace', 0)) %}
            <div class="badges" style="margin-top:.35rem">
              {% if b.get('Box', 0) %}<span class="chip">Box: {{ b.get('Box') }}</span>{% endif %}
              {% if b.get('Organizator', 0) %}<span class="chip">Org: {{ b.get('Organizator') }}</span>{% endif %}
              {% if b.get('InPlace', 0) %}<span class="chip">IP: {{ b.get('InPlace') }}</span>{% endif %}
              {% if not bsum %}<span class="muted">No containers</span>{% endif %}
            </div>
          </div>

        </li>
        {% endfor %}
        {% if drawers|length == 0 %}
          <li class="empty">No drawers</li>
        {% endif %}
      </ul>
    </div>


  <!-- Modal: Add Shelf/Drawer -->
  <div id="addNodeModal" class="modal modal-small">
    <div class="modal-content card">
      <div class="card-pad">
        <h2 class="kicker">New child</h2>
        <form action="/nodes" method="post" class="stack">
          <input type="hidden" name="parent_id" value="{{ node['id'] }}">
          <label>Type
            <select name="type" id="nodeTypeSelect">
              <option value="Shelf">Shelf</option>
              <option value="Drawer">Drawer</option>
            </select>
          </label>
          <label>Name <input required name="name" placeholder="e.g., Top shelf"></label>
          <label>Note <input name="note" placeholder="optional"></label>
          <div class="row" style="gap:8px; justify-content:flex-end;">
            <button type="button" class="ghost" id="cancelNode">Cancel</button>
            <button class="primary">Create</button>
          </div>
        </form>
      </div>
    </div>
  </div>


{% elif node['type'] in ['Shelf','Drawer'] %}
  <!-- Shelf/Drawer page: filter containers + compact tiles; inline + button -->
  <div class="section">
    <div class="row toolbar-mini" style="justify-content:space-between;">
      <div class="kicker">Containers here</div>
      <button type="button" class="icon-btn plus" id="addContBtn" title="Add container">+</button>
    </div>

    <ul class="cards subgrid" id="contGrid">
      {% for c in containers %}
        <li class="card subcard {% if loop.index0 >= 24 %}hidden-cont{% endif %}" data-name="{{ (c['name'] ~ ' ' ~ c['type'])|lower }}">
          <div class="card-pad">
            <div class="badges">
            </div>

            <!-- name -->
            <h3 style="margin:.3rem 0 0 0">
              <a class="link" href="/container/{{ c['id'] }}">{{ c['name'] }}</a>
              <span class="pill">{{ c['type'] }}</span>
            </h3>


            {% if c['note'] %}
              <div class="muted small-note">{{ c['note'] }}</div>
            {% endif %}
                        <!-- INSERT THIS BLOCK ‚Üì‚Üì‚Üì -->
            {% set ic = items_count.get(c['id'], 0) if items_count else 0 %}
            {% if ic > 0 %}
              <div class="badges" style="margin-top:.35rem">
                <span class="chip accent">Items: {{ ic }}</span>
              </div>
            {% else %}
              <div class="muted">No items</div>
            {% endif %}
            <!-- ‚Üë‚Üë‚Üë -->

          </div>
        </li>


        
      {% else %}
      <li class="empty">No containers yet.</li>
      {% endfor %}
    </ul>

    {% if containers|length > 24 %}
      <div class="row" style="justify-content:center; margin-top:.8rem;">
        <button class="ghost tiny" id="toggleCont">Show more</button>
      </div>
    {% endif %}
  </div>

  <!-- Modal: Add Container -->
  <div id="addContModal" class="modal modal-small">
    <div class="modal-content card">
      <div class="card-pad">
        <h2 class="kicker">New container</h2>
        <form action="/containers" method="post" class="stack">
          <input type="hidden" name="parent_id" value="{{ node['id'] }}">
          <label>Type
            <select name="type" id="contType">
              {% if node['type']=='Shelf' %}
                <option value="Box">Box</option>
                <option value="Organizator">Organizator</option>
                <option value="InPlace">In Place</option>
              {% else %}
                <option value="Organizator">Organizator</option>
                <option value="InPlace">In Place</option>
              {% endif %}
            </select>
          </label>
          <label>Name <input required name="name" placeholder="e.g., Winter box"></label>
          <label>Note <input name="note" placeholder="optional"></label>
          <div class="row" style="gap:8px; justify-content:flex-end;">
            <button type="button" class="ghost" id="cancelCont">Cancel</button>
            <button class="primary">Create</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endif %}

<script>
  // Show more/less for shelves
  const toggleShelves = document.getElementById('toggleShelves');
  if (toggleShelves){
    let expanded = false;
    toggleShelves.addEventListener('click', ()=>{
      expanded = !expanded;
      document.querySelectorAll('.hidden-shelf').forEach(el => el.style.display = expanded ? '' : 'none');
      toggleShelves.textContent = expanded ? 'Show fewer' : 'Show more';
    });
    document.querySelectorAll('.hidden-shelf').forEach(el => el.style.display = 'none');
  }

  // Show more/less for drawers
  const toggleDrawers = document.getElementById('toggleDrawers');
  if (toggleDrawers){
    let expanded = false;
    toggleDrawers.addEventListener('click', ()=>{
      expanded = !expanded;
      document.querySelectorAll('.hidden-drawer').forEach(el => el.style.display = expanded ? '' : 'none');
      toggleDrawers.textContent = expanded ? 'Show fewer' : 'Show more';
    });
    document.querySelectorAll('.hidden-drawer').forEach(el => el.style.display = 'none');
  }

  // Header [+] (Cabinet/Wardrobe page) ‚Äî opens Add Shelf/Drawer modal
  const addNodeBtn   = document.getElementById('addNodeBtn');
  const addNodeModal = document.getElementById('addNodeModal');
  const cancelNode   = document.getElementById('cancelNode');
  if (addNodeBtn){ addNodeBtn.addEventListener('click', ()=> addNodeModal.style.display='flex'); }
  if (cancelNode){ cancelNode.addEventListener('click', ()=> addNodeModal.style.display='none'); }
  if (addNodeModal){ addNodeModal.addEventListener('click', (e)=>{ if(e.target===addNodeModal) addNodeModal.style.display='none'; }); }

  // Shelf/Drawer page: [+] Add Container modal
  const addContBtn   = document.getElementById('addContBtn');
  const addContModal = document.getElementById('addContModal');
  const cancelCont   = document.getElementById('cancelCont');
  if (addContBtn){ addContBtn.addEventListener('click', ()=> addContModal.style.display='flex'); }
  if (cancelCont){ cancelCont.addEventListener('click', ()=> addContModal.style.display='none'); }
  if (addContModal){ addContModal.addEventListener('click', (e)=>{ if(e.target===addContModal) addContModal.style.display='none'; }); }

  // Escape to close any open modal
  window.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      if(addNodeModal) addNodeModal.style.display='none';
      if(addContModal) addContModal.style.display='none';
    }
  });

  // Optional: live filter for containers (kept)
  const contFilter = document.getElementById('contFilter');
  if (contFilter){
    const cards = [...document.querySelectorAll('#contGrid .subcard')];
    contFilter.addEventListener('input', e => {
      const q = e.target.value.trim().toLowerCase();
      cards.forEach(el => {
        const name = el.dataset.name || '';
        el.style.display = name.includes(q) ? '' : 'none';
      });
    });
  }

  function confirmTopDelete(){
    return confirm('Delete this top-level and EVERYTHING inside it? This cannot be undone.');
  }
  
  function confirmTopDeleteWithType(form){
    const t = (form.getAttribute('data-ntype') || 'this').toLowerCase();
    return confirm(`Delete this ${t} and EVERYTHING inside it? This cannot be undone.`);
  }
    function confirmNodeDelete(form){
    const t = (form.getAttribute('data-ntype') || 'this').toLowerCase();
    return confirm(`Delete this ${t} and EVERYTHING inside it? This cannot be undone.`);
  }
</script>


{% endblock %}