{% extends "base.html" %}
{% block content %}

<div class="section grid-2">
  <div class="col">

    <!-- Back rail + header card, aligned on the left -->
    <div class="section header-row-outside">
      <a class="back-rail" href="{% if parent %}/node/{{ parent['id'] }}{% else %}/{% endif %}" aria-label="Back" title="Back">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M15 18L9 12l6-6" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>

      <div class="card">
        <div class="card-pad">
          <div class="badges breadcrumb-inline">
            {% if top %}
              <a class="link crumb" href="/node/{{ top['id'] }}">{{ top['type'] }} ‚Äî {{ top['name'] }}</a>
              {% if top['note'] %}<span class="sep">‚Ä¢</span><span class="note" title="{{ top['note'] }}">{{ top['note'] }}</span>{% endif %}
            {% endif %}
            {% if top or parent %}<span class="sep">‚Ä∫</span>{% endif %}
            {% if parent %}
              <a class="link crumb" href="/node/{{ parent['id'] }}">{{ parent['type'] }} ‚Äî {{ parent['name'] }}</a>
              {% if parent['note'] %}<span class="sep">‚Ä¢</span><span class="note" title="{{ parent['note'] }}">{{ parent['note'] }}</span>{% endif %}
              <span class="sep">‚Ä∫</span>
            {% endif %}
            <span class="pill">{{ cont['type'] }}</span>
          </div>

          <div class="row" style="justify-content:space-between; align-items:center; margin-top:.3rem;">
            <h2 style="margin:.3rem 0 0 0">
              {{ cont['name'] }} <span class="muted">(#{{ cont['id'] }})</span>
            </h2>

            <div class="row" style="gap:8px;">
              <!-- Move container -->
              <button class="icon-btn move" id="openMoveContainer" type="button" title="Move container" aria-label="Move container">
                ‚áÑ
              </button>

              <!-- Delete container -->
              <form class="no-shrink" action="/container/{{ cont['id'] }}/delete" method="post"
                    data-ctype="{{ cont['type'] }}"
                    onsubmit="return confirmContainerDelete(this);">
                <button class="icon-btn danger" type="submit"
                        aria-label="Delete {{ cont['type'] }}" title="Delete {{ cont['type'] }}">üóëÔ∏è</button>
              </form>
            </div>
          </div>

          {% if cont['note'] %}<div class="muted">{{ cont['note'] }}</div>{% endif %}
        </div>
      </div>
    </div>
    <!-- /Back rail + header -->

    <!-- Items (left column) -->
    <div class="section">
      <div class="row toolbar-mini" style="justify-content:space-between;">
        <h2 class="kicker" style="margin:0">Items</h2>
        <button type="button" class="icon-btn plus" id="addItemBtn" title="Add item">+</button>
      </div>

      <div class="card">
        <div class="card-pad">
          <ul class="list">
            {% for it in items %}
            <li>
              <div><strong>{{ it['name'] }}</strong> √ó {{ it['qty'] }}</div>
              {% if it['note'] %}<div class="muted">{{ it['note'] }}</div>{% endif %}

              <div class="row" style="gap:8px; margin-left:auto;">
                <!-- Move item -->
                <button class="icon-btn move openMoveItem"
                        type="button"
                        data-item-id="{{ it['id'] }}"
                        title="Move item" aria-label="Move item">‚áÑ</button>
                <!-- Inside the <li> for each item -->
                <div class="row" style="gap:8px; margin-left:auto;">
                  <button class="icon-btn" type="button" title="Edit item" aria-label="Edit item"
                          data-item-id="{{ it['id'] }}" onclick="openEditItem(this)">‚úé</button>
                  <form action="/container/{{ cont['id'] }}/items/{{ it['id'] }}/delete" method="post">
                    <button class="danger">Delete</button>
                  </form>
                </div>

                {% set extras = item_dyn.get(it['id'], []) %}
                {% if extras and extras|length %}
                  <div class="badges" style="margin-top:.35rem">
                    {% for x in extras %}
                      <span class="chip">{{ x.label }}: {{ x.value }}</span>
                    {% endfor %}
                  </div>
                {% endif %}


                <!-- Delete item -->
                <form action="/container/{{ cont['id'] }}/items/{{ it['id'] }}/delete" method="post">
                  <button class="danger">Delete</button>
                </form>
              </div>
            </li>
            {% else %}
            <li class="empty">No items yet.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

  </div>

  <!-- QR (right column) -->
  <aside class="col">
    <div class="section">
      <div class="card sticky">
        <div class="card-pad">
          <div class="badges"><span class="pill">QR label</span></div>
          <p class="muted" style="margin-top:.4rem">Scan to open this container.</p>
          <p style="display:grid; place-items:center; margin:.8rem 0;">
            <img src="/container/{{ cont['id'] }}/qr.png" alt="QR for this container" style="max-width:220px; width:100%; height:auto">
          </p>
          <form action="/container/{{ cont['id'] }}/qr/refresh" method="post" class="row" style="gap:8px; justify-content:center;">
            <button class="ghost" type="submit" title="Regenerate QR">Refresh QR</button>
            <a class="link" href="/container/{{ cont['id'] }}/qr.png" download>Download PNG</a>
          </form>
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- Modal: Add Item -->
<div id="addItemModal" class="modal modal-small">
  <div class="modal-content card">
    <div class="card-pad">
      <h2 class="kicker">Add item</h2>
      <form id="addItemForm" action="/container/{{ cont['id'] }}/items" method="post" class="stack">
        <label>Type
          <select name="type_id" id="addTypeSelect">
            <option value="">‚Äî none ‚Äî</option>
            {% for t in item_types %}
              <option value="{{ t['id'] }}">{{ t['name'] }}</option>
            {% endfor %}
          </select>
        </label>
        <div id="addDynFields"></div>

        <label>Name
          <input required name="name" placeholder="e.g., Socks">
        </label>
        <label>Quantity
          <input type="number" min="1" value="1" name="qty">
        </label>
        <label>Note
          <input name="note" placeholder="optional">
        </label>
        <div class="row" style="gap:8px; justify-content:flex-end;">
          <button type="button" class="ghost" id="cancelItem">Cancel</button>
          <button class="primary" type="submit">Add</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Edit Item -->
<div id="editItemModal" class="modal modal-small">
  <div class="modal-content card">
    <div class="card-pad">
      <h2 class="kicker">Edit item</h2>
      <form id="editItemForm" action="" method="post" class="stack">
        <input type="hidden" id="editItemId">
        <label>Type
          <select name="type_id" id="editTypeSelect">
            <option value="">‚Äî none ‚Äî</option>
            {% for t in item_types %}
              <option value="{{ t['id'] }}">{{ t['name'] }}</option>
            {% endfor %}
          </select>
        </label>
        <div id="editDynFields"></div>

        <label>Name
          <input required name="name" id="editName">
        </label>
        <label>Quantity
          <input type="number" min="1" name="qty" id="editQty">
        </label>
        <label>Note
          <input name="note" id="editNote">
        </label>
        <div class="row" style="gap:8px; justify-content:flex-end;">
          <button type="button" class="ghost" id="cancelEdit">Cancel</button>
          <button class="primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>





<!-- Modal: Move CONTAINER -->
<div id="moveContainerModal" class="modal modal-small">
  <div class="modal-content card">
    <div class="card-pad">
      <h2 class="kicker">Move container</h2>
      <form action="/container/{{ cont['id'] }}/move" method="post" class="stack">
        <label>Destination (Shelf/Drawer)
          <select name="dest_parent_id" required>
            {% for n in move_nodes %}
              <option value="{{ n['id'] }}">
                {{ n['parent_name'] }}{% if n['parent_note'] %} ‚Ä¢ {{ n['parent_note'] }}{% endif %}
                ‚Ä∫ {{ n['name'] }}{% if n['note'] %} ‚Ä¢ {{ n['note'] }}{% endif %}
              </option>
            {% endfor %}
          </select>



        </label>
        <div class="row" style="gap:8px; justify-content:flex-end;">
          <button type="button" class="ghost" id="cancelMoveCont">Cancel</button>
          <button class="primary" type="submit">Move</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Move ITEM -->
<div id="moveItemModal" class="modal modal-small">
  <div class="modal-content card">
    <div class="card-pad">
      <h2 class="kicker">Move item</h2>
      <form id="moveItemForm" action="/container/{{ cont['id'] }}/items/move" method="post" class="stack">
        <input type="hidden" name="item_id" id="moveItemId">
        <label>Destination container
          <select name="dest_container_id" required>
            {% for c in move_containers %}
              <option value="{{ c['id'] }}">
                {% if c['top_name'] %}
                  {{ c['top_name'] }}{% if c['top_note'] %} ‚Ä¢ {{ c['top_note'] }}{% endif %} ‚Ä∫
                {% endif %}
                {{ c['parent_name'] }}{% if c['parent_note'] %} ‚Ä¢ {{ c['parent_note'] }}{% endif %} ‚Ä∫
                {{ c['type'] }} ‚Äî {{ c['name'] }}{% if c['note'] %} ‚Ä¢ {{ c['note'] }}{% endif %}
              </option>
            {% endfor %}
          </select>



        </label>
        <div class="row" style="gap:8px; justify-content:flex-end;">
          <button type="button" class="ghost" id="cancelMoveItem">Cancel</button>
          <button class="primary" type="submit">Move</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // ---------- helpers ----------
  async function fetchJSON(url){ const r = await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }

  function renderFields(containerEl, fields, values){
    containerEl.innerHTML = '';
    fields.forEach(f=>{
      const wrap = document.createElement('label');
      wrap.textContent = f.label;
      let input;
      const name = 'field_' + f.id;
      const val = values && values[f.id] !== undefined ? values[f.id] : '';

      if (f.kind === 'text' || f.kind === 'date' || f.kind === 'number'){
        input = document.createElement('input');
        input.name = name;
        input.type = (f.kind === 'text') ? 'text' : (f.kind === 'date' ? 'date' : 'number');
        input.value = val;
      } else if (f.kind === 'checkbox'){
        input = document.createElement('input');
        input.name = name;
        input.type = 'checkbox';
        input.checked = (val === '1' || val === 'true' || val === 'on');
      } else if (f.kind === 'select'){
        input = document.createElement('select');
        input.name = name;
        (f.options || []).forEach(opt=>{
          const o = document.createElement('option');
          o.value = opt; o.textContent = opt;
          if (opt === val) o.selected = true;
          input.appendChild(o);
        });
      }
      if (f.required){ input.required = true; }
      // spacing
      input.style.marginTop = '8px';
      input.style.padding = '10px 12px';
      wrap.appendChild(input);
      containerEl.appendChild(wrap);
      const spacer = document.createElement('div'); spacer.style.height='6px'; containerEl.appendChild(spacer);
    });
  }

  // ---------- ADD ITEM modal ----------
  const addItemBtn   = document.getElementById('addItemBtn');
  const addItemModal = document.getElementById('addItemModal');
  const cancelItem   = document.getElementById('cancelItem');
  const addTypeSel   = document.getElementById('addTypeSelect');
  const addDynFields = document.getElementById('addDynFields');

  if(addItemBtn){ addItemBtn.addEventListener('click', ()=> addItemModal.style.display='flex'); }
  if(cancelItem){ cancelItem.addEventListener('click', ()=> addItemModal.style.display='none'); }
  if(addItemModal){ addItemModal.addEventListener('click', (e)=>{ if(e.target===addItemModal) addItemModal.style.display='none'; }); }

  if(addTypeSel){
    addTypeSel.addEventListener('change', async (e)=>{
      const tid = e.target.value;
      if(!tid){ addDynFields.innerHTML=''; return; }
      const fields = await fetchJSON(`/api/item-types/${tid}/fields`);
      renderFields(addDynFields, fields, null);
    });
  }

  // ---------- EDIT ITEM modal ----------
  const editItemModal = document.getElementById('editItemModal');
  const cancelEdit    = document.getElementById('cancelEdit');
  const editTypeSel   = document.getElementById('editTypeSelect');
  const editDynFields = document.getElementById('editDynFields');
  const editName      = document.getElementById('editName');
  const editQty       = document.getElementById('editQty');
  const editNote      = document.getElementById('editNote');
  const editForm      = document.getElementById('editItemForm');

  if(cancelEdit){ cancelEdit.addEventListener('click', ()=> editItemModal.style.display='none'); }
  if(editItemModal){ editItemModal.addEventListener('click', (e)=>{ if(e.target===editItemModal) editItemModal.style.display='none'; }); }

  async function openEditItem(btn){
    const id = btn.getAttribute('data-item-id');
    const data = await fetchJSON(`/api/items/${id}`);

    // set base fields
    editForm.action = `/container/{{ cont['id'] }}/items/${id}/update`;
    document.getElementById('editItemId').value = id;
    editName.value = data.item.name || '';
    editQty.value  = data.item.qty || 1;
    editNote.value = data.item.note || '';
    editTypeSel.value = data.item.type_id || '';

    // map dynamic values by field_id
    const valmap = {};
    (data.fields || []).forEach(f=>{ valmap[f.field_id] = f.value; });

    if(editTypeSel.value){
      const fields = await fetchJSON(`/api/item-types/${editTypeSel.value}/fields`);
      renderFields(editDynFields, fields, valmap);
    } else {
      editDynFields.innerHTML = '';
    }

    editItemModal.style.display = 'flex';
  }
  window.openEditItem = openEditItem;

  // change type on edit -> refetch fields
  if(editTypeSel){
    editTypeSel.addEventListener('change', async (e)=>{
      const tid = e.target.value;
      if(!tid){ editDynFields.innerHTML=''; return; }
      const fields = await fetchJSON(`/api/item-types/${tid}/fields`);
      renderFields(editDynFields, fields, {});
    });
  }

  // Esc closes modals
  window.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      if(addItemModal) addItemModal.style.display='none';
      if(editItemModal) editItemModal.style.display='none';
    }
  });
</script>





{% endblock %}
