{% extends "base.html" %}
{% block content %}

<div class="section grid-2">
  <div class="col">

    <!-- Back rail + header card, aligned on the left -->
    <div class="section header-row-outside">
      <a class="back-rail" href="{% if parent %}/node/{{ parent['id'] }}{% else %}/{% endif %}" aria-label="Back" title="Back">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M15 18L9 12l6-6" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>

      <div class="card">
        <div class="card-pad">
          <div class="badges breadcrumb-inline">
            {% if top %}
              <a class="link crumb" href="/node/{{ top['id'] }}">{{ top['type'] }} ‚Äî {{ top['name'] }}</a>
              {% if top['note'] %}<span class="sep">‚Ä¢</span><span class="note" title="{{ top['note'] }}">{{ top['note'] }}</span>{% endif %}
            {% endif %}
            {% if top or parent %}<span class="sep">‚Ä∫</span>{% endif %}
            {% if parent %}
              <a class="link crumb" href="/node/{{ parent['id'] }}">{{ parent['type'] }} ‚Äî {{ parent['name'] }}</a>
              {% if parent['note'] %}<span class="sep">‚Ä¢</span><span class="note" title="{{ parent['note'] }}">{{ parent['note'] }}</span>{% endif %}
              <span class="sep">‚Ä∫</span>
            {% endif %}
            <span class="pill">{{ cont['type'] }}</span>
          </div>

          <div class="row" style="justify-content:space-between; align-items:center; margin-top:.3rem;">
            <h2 style="margin:.3rem 0 0 0">
              {{ cont['name'] }} <span class="muted">(#{{ cont['id'] }})</span>
            </h2>

            <div class="row" style="gap:8px;">
              <!-- Move container -->
              <button class="icon-btn move" id="openMoveContainer" type="button" title="Move container" aria-label="Move container">
                ‚áÑ
              </button>

              <!-- Delete container -->
              <form class="no-shrink needs-confirm"
                    action="/container/{{ cont['id'] }}/delete"
                    method="post"
                    data-confirm="Delete {{ cont['type'] }} ‚Äî {{ cont['name'] }} (and its items)?">
                <button class="icon-btn danger" type="submit" aria-label="Delete {{ cont['type'] }}" title="Delete {{ cont['type'] }}">üóëÔ∏è</button>
              </form>
            </div>
          </div>

          {% if cont['note'] %}<div class="muted">{{ cont['note'] }}</div>{% endif %}
        </div>
      </div>
    </div>
    <!-- /Back rail + header -->

    <!-- Items (left column) -->
    <div class="section">
      <div class="row toolbar-mini" style="justify-content:space-between;">
        <h2 class="kicker" style="margin:0">Items</h2>
        <button type="button" class="icon-btn plus" id="addItemBtn" title="Add item">+</button>
      </div>

      <div class="card">
        <div class="card-pad">
          <ul class="list">
            {% for it in items %}
              <li class="item-row">
                <div class="item-main">
                  <div class="title"><strong>{{ it['name'] }}</strong> √ó {{ it['qty'] }}</div>
                  {% if it['note'] %}<div class="muted">{{ it['note'] }}</div>{% endif %}

                  {% set extras = item_dyn.get(it['id'], []) %}
                  {% if extras and extras|length %}
                  <div class="extras-wrap">
                    <div class="badges extras-inline {% if extras|length > 4 %}collapsible{% endif %}"
                        id="extras-{{ it['id'] }}">
                      {% for x in extras %}
                        <span class="pill">{{ x.label }}: {{ x.value }}</span>
                      {% endfor %}
                    </div>

                    {% if extras|length > 4 %}
                      <button type="button"
                              class="icon-btn extras-more-btn count-btn"
                              data-target="extras-{{ it['id'] }}"
                              aria-label="Show {{ extras|length - 4 }} more"
                              title="Show {{ extras|length - 4 }} more">
                        ‚ãØ <span class="more-count">+{{ extras|length - 4 }}</span>
                      </button>
                    {% endif %}
                  </div>

                  {% endif %}
                </div>  <!-- ‚Üê close .item-main here -->

                <!-- Actions must be a sibling so they can live top-right -->
                <div class="item-actions">
                  <div class="actions-top">
                    <button class="icon-btn move openMoveItem"
                            type="button"
                            data-item-id="{{ it['id'] }}"
                            title="Move item" aria-label="Move item">‚áÑ</button>

                  <form class="needs-confirm"
                        action="/container/{{ cont['id'] }}/items/{{ it['id'] }}/delete"
                        method="post"
                        data-confirm="Delete this item?">
                    <button class="icon-btn danger" title="Delete item" aria-label="Delete item">üóëÔ∏è</button>
                  </form>
                  </div>

                  <button class="icon-btn edit-btn" type="button" title="Edit item" aria-label="Edit item"
                          data-item-id="{{ it['id'] }}" onclick="openEditItem(this)">‚úé</button>
                </div>
              </li>


            {% else %}
            <li class="empty">No items yet.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

  </div>

  <!-- QR (right column) -->
  <aside class="col">
    <div class="section">
      <div class="card sticky">
        <div class="card-pad">
          <div class="badges"><span class="pill">QR label</span></div>
          <p class="muted" style="margin-top:.4rem">Scan to open this container.</p>
          <p style="display:grid; place-items:center; margin:.8rem 0;">
            <img src="/container/{{ cont['id'] }}/qr.png" alt="QR for this container" style="max-width:220px; width:100%; height:auto">
          </p>
          <form action="/container/{{ cont['id'] }}/qr/refresh" method="post" class="row" style="gap:8px; justify-content:center;">
            <button class="ghost" type="submit" title="Regenerate QR">Refresh QR</button>
            <a class="link" href="/container/{{ cont['id'] }}/qr.png" download>Download PNG</a>
          </form>
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- Modal: Add Item -->
<div id="addItemModal" class="modal modal-small">
  <div class="modal-content card">
    <div class="card-pad">
      <h2 class="kicker">Add item</h2>
      <form id="addItemForm" action="/container/{{ cont['id'] }}/items" method="post" class="stack">
        <label>Type
          <select name="type_id" id="addTypeSelect">
            <option value="">‚Äî none ‚Äî</option>
            {% for t in item_types %}
              <option value="{{ t['id'] }}">{{ t['name'] }}</option>
            {% endfor %}
          </select>
        </label>
        <div id="addDynFields"></div>

        <label>Name
          <input required name="name" placeholder="e.g., Socks">
        </label>
        <label>Quantity
          <input type="number" min="1" value="1" name="qty">
        </label>
        <label>Note
          <input name="note" placeholder="optional">
        </label>
        <div class="row" style="gap:8px; justify-content:flex-end;">
          <button type="button" class="ghost" id="cancelItem">Cancel</button>
          <button class="primary" type="submit">Add</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Edit Item -->
<div id="editItemModal" class="modal modal-small">
  <div class="modal-content card">
    <div class="card-pad">
      <h2 class="kicker">Edit item</h2>
      <form id="editItemForm" action="" method="post" class="stack">
        <input type="hidden" id="editItemId">
        <label>Type
          <select name="type_id" id="editTypeSelect">
            <option value="">‚Äî none ‚Äî</option>
            {% for t in item_types %}
              <option value="{{ t['id'] }}">{{ t['name'] }}</option>
            {% endfor %}
          </select>
        </label>
        <div id="editDynFields"></div>

        <label>Name
          <input required name="name" id="editName">
        </label>
        <label>Quantity
          <input type="number" min="1" name="qty" id="editQty">
        </label>
        <label>Note
          <input name="note" id="editNote">
        </label>
        <div class="row" style="gap:8px; justify-content:flex-end;">
          <button type="button" class="ghost" id="cancelEdit">Cancel</button>
          <button class="primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>





<!-- Modal: Move CONTAINER -->
<!-- Modal: Move CONTAINER -->
<div id="moveContainerModal" class="modal modal-small">
  <div class="modal-content card">
    <div class="card-pad">
      <h2 class="kicker">Move container</h2>
      <!-- add id -->
      <form id="moveContainerForm" action="/container/{{ cont['id'] }}/move" method="post" class="stack">
        <label class="block">Destination (Shelf/Drawer)</label>
        <div class="dest-inline">
          <select name="dest_parent_id" id="scanDestParentBtn" required>
            {% for n in move_nodes %}
              <option value="{{ n['id'] }}">
                {{ n['parent_name'] }}{% if n['parent_note'] %} ‚Ä¢ {{ n['parent_note'] }}{% endif %}
                ‚Ä∫ {{ n['name'] }}{% if n['note'] %} ‚Ä¢ {{ n['note'] }}{% endif %}
              </option>
            {% endfor %}
          </select>

          <button type="button"
                  class="icon-btn qr-inline-btn"
                  id="scanDestParentBtn"
                  title="Scan QR" aria-label="Scan QR">
            <img src="/static/QR_Icon.png" alt="" width="26" height="26" decoding="async" draggable="false">
          </button>
        </div>


        <div class="row" style="gap:8px; justify-content:flex-end;">
          <button type="button" class="ghost" id="cancelMoveCont">Cancel</button>
          <button class="primary" type="submit">Move</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Modal: Move ITEM -->
<div id="moveItemModal" class="modal modal-small">
  <div class="modal-content card">
    <div class="card-pad">
      <h2 class="kicker">Move item</h2>
      <form id="moveItemForm" action="/container/{{ cont['id'] }}/items/move" method="post" class="stack">
        <input type="hidden" name="item_id" id="moveItemId">
          <label class="block">Destination container</label>
          <div class="dest-inline">
            <select name="dest_container_id" id="scanDestBtn" required>
              {% for c in move_containers %}
                <option value="{{ c['id'] }}">
                  {% if c['top_name'] %}
                    {{ c['top_name'] }}{% if c['top_note'] %} ‚Ä¢ {{ c['top_note'] }}{% endif %} ‚Ä∫
                  {% endif %}
                  {{ c['parent_name'] }}{% if c['parent_note'] %} ‚Ä¢ {{ c['parent_note'] }}{% endif %} ‚Ä∫
                  {{ c['type'] }} ‚Äî {{ c['name'] }}{% if c['note'] %} ‚Ä¢ {{ c['note'] }}{% endif %}
                </option>
              {% endfor %}
            </select>

            <button type="button"
                    class="icon-btn qr-inline-btn"
                    id="scanDestItemBtn"
                    title="Scan QR" aria-label="Scan QR">
              <img src="/static/QR_Icon.png" alt="" width="26" height="26" decoding="async" draggable="false">
            </button>
          </div>

        <div class="row" style="gap:8px; justify-content:flex-end;">
          <button type="button" class="ghost" id="cancelMoveItem">Cancel</button>
          <button class="primary" type="submit">Move</button>
        </div>
      </form>
    </div>
  </div>
</div>



<script>
(() => {
  const scanBtn   = document.getElementById('scanDestBtn');
  const moveForm  = document.getElementById('moveItemForm');
  const destSel   = document.getElementById('moveDestSelect');

  if (!scanBtn || !moveForm || !destSel) return;

  scanBtn.addEventListener('click', () => {
    // tell the global scanner to hand the ID back here
    window.qrScanHook = (id) => {
      // ensure the scanned id exists in the dropdown (add a temp option if not)
      let opt = destSel.querySelector(`option[value="${id}"]`);
      if (!opt) {
        opt = document.createElement('option');
        opt.value = id;
        opt.textContent = 'Scanned container ‚Ä¢ ' + id;
        destSel.insertBefore(opt, destSel.firstChild);
      }
      destSel.value = id;

      // close the scanner and clear the hook
      if (typeof window.closeQrScanner === 'function') window.closeQrScanner();
      window.qrScanHook = null;

      // submit the move
      moveForm.submit();
    };

    // open the global scanner modal (from the header)
    if (typeof window.openQrScanner === 'function') {
      window.openQrScanner();
    } else {
      // fallback: try clicking existing buttons that open it
      document.getElementById('scanQrMenu')?.click();
      document.getElementById('qrBtn')?.click();
    }
  });
})();
</script>

<script>

(function(){
  const modal   = document.getElementById('confirmModal');
  const msgEl   = document.getElementById('confirmMsg');
  const okBtn   = document.getElementById('confirmOk');
  const cancel  = document.getElementById('confirmCancel');
  let pendingForm = null;

  function open(msg){
    msgEl.textContent = msg || 'Are you sure?';
    modal.style.display = 'flex';
  }
  function close(){ modal.style.display = 'none'; }

  // Click backdrop to close
  modal.addEventListener('click', (e)=>{ if(e.target === modal) close(); });
  cancel.addEventListener('click', close);

  okBtn.addEventListener('click', ()=>{
    if(pendingForm){
      // programmatic submit bypasses our listener
      pendingForm.submit();
      pendingForm = null;
    }
    close();
  });

  // Hook all forms that need confirmation
  document.querySelectorAll('form.needs-confirm').forEach(form=>{
    form.addEventListener('submit', (e)=>{
      // if already confirmed (e.g. navigated back), let it pass
      if(form.dataset.confirmed === '1') return;
      e.preventDefault();
      pendingForm = form;
      open(form.dataset.confirm || 'Are you sure you want to delete this?');
    }, { capture:true });
  });

  // ESC to close
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
})();


document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.extras-more-btn');
  if(!btn) return;

  const id   = btn.dataset.target;
  const grid = document.getElementById(id);
  if(!grid) return;

  const total  = grid.querySelectorAll('.pill').length;
  const hidden = Math.max(0, total - 4);

  const expanded = grid.classList.toggle('expanded');

  if(expanded){
    btn.setAttribute('aria-label','Show less');
    btn.setAttribute('title','Show less');
    btn.innerHTML = '‚Äì <span class="more-count">less</span>';
  }else{
    btn.setAttribute('aria-label', `Show ${hidden} more`);
    btn.setAttribute('title',      `Show ${hidden} more`);
    btn.innerHTML = `‚ãØ <span class="more-count">+${hidden}</span>`;
  }
});



    // === MOVE CONTAINER modal ===
  (function(){
    const btn   = document.getElementById('openMoveContainer');
    const modal = document.getElementById('moveContainerModal');
    const cancel= document.getElementById('cancelMoveCont');
    if(!modal) return;

    if(btn)     btn.addEventListener('click', ()=> modal.style.display='flex');
    if(cancel)  cancel.addEventListener('click', ()=> modal.style.display='none');
    modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.style.display='none'; });
  })();

  // === MOVE ITEM modal ===
  (function(){
    const modal   = document.getElementById('moveItemModal');
    const cancel  = document.getElementById('cancelMoveItem');
    const hiddenId= document.getElementById('moveItemId');
    if(!modal) return;

    document.querySelectorAll('.openMoveItem').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(hiddenId) hiddenId.value = btn.getAttribute('data-item-id');
        modal.style.display = 'flex';
      });
    });

    if(cancel)  cancel.addEventListener('click', ()=> modal.style.display='none');
    modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.style.display='none'; });
  })();

  // === ESC closes all modals (add, edit, move item, move container) ===
  window.addEventListener('keydown', (e)=>{
    if(e.key !== 'Escape') return;
    ['addItemModal','editItemModal','moveContainerModal','moveItemModal'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.style.display='none';
    });
  });
  // ---------- helpers ----------
  async function fetchJSON(url){ const r = await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }

  function renderFields(containerEl, fields, values){
    containerEl.innerHTML = '';
    fields.forEach(f=>{
      const wrap = document.createElement('label');
      wrap.textContent = f.label;
      let input;
      const name = 'field_' + f.id;
      const val = values && values[f.id] !== undefined ? values[f.id] : '';

      if (f.kind === 'text' || f.kind === 'date' || f.kind === 'number'){
        input = document.createElement('input');
        input.name = name;
        input.type = (f.kind === 'text') ? 'text' : (f.kind === 'date' ? 'date' : 'number');
        input.value = val;
      } else if (f.kind === 'checkbox'){
        input = document.createElement('input');
        input.name = name;
        input.type = 'checkbox';
        input.checked = (val === '1' || val === 'true' || val === 'on');
      } else if (f.kind === 'select'){
        input = document.createElement('select');
        input.name = name;
        (f.options || []).forEach(opt=>{
          const o = document.createElement('option');
          o.value = opt; o.textContent = opt;
          if (opt === val) o.selected = true;
          input.appendChild(o);
        });
      }
      if (f.required){ input.required = true; }
      // spacing
      input.style.marginTop = '8px';
      input.style.padding = '10px 12px';
      wrap.appendChild(input);
      containerEl.appendChild(wrap);
      const spacer = document.createElement('div'); spacer.style.height='6px'; containerEl.appendChild(spacer);
    });
  }

  // ---------- ADD ITEM modal ----------
  const addItemBtn   = document.getElementById('addItemBtn');
  const addItemModal = document.getElementById('addItemModal');
  const cancelItem   = document.getElementById('cancelItem');
  const addTypeSel   = document.getElementById('addTypeSelect');
  const addDynFields = document.getElementById('addDynFields');

  if(addItemBtn){ addItemBtn.addEventListener('click', ()=> addItemModal.style.display='flex'); }
  if(cancelItem){ cancelItem.addEventListener('click', ()=> addItemModal.style.display='none'); }
  if(addItemModal){ addItemModal.addEventListener('click', (e)=>{ if(e.target===addItemModal) addItemModal.style.display='none'; }); }

  if(addTypeSel){
    addTypeSel.addEventListener('change', async (e)=>{
      const tid = e.target.value;
      if(!tid){ addDynFields.innerHTML=''; return; }
      const fields = await fetchJSON(`/api/item-types/${tid}/fields`);
      renderFields(addDynFields, fields, null);
    });
  }

  // ---------- EDIT ITEM modal ----------
  const editItemModal = document.getElementById('editItemModal');
  const cancelEdit    = document.getElementById('cancelEdit');
  const editTypeSel   = document.getElementById('editTypeSelect');
  const editDynFields = document.getElementById('editDynFields');
  const editName      = document.getElementById('editName');
  const editQty       = document.getElementById('editQty');
  const editNote      = document.getElementById('editNote');
  const editForm      = document.getElementById('editItemForm');

  if(cancelEdit){ cancelEdit.addEventListener('click', ()=> editItemModal.style.display='none'); }
  if(editItemModal){ editItemModal.addEventListener('click', (e)=>{ if(e.target===editItemModal) editItemModal.style.display='none'; }); }

  async function openEditItem(btn){
    const id = btn.getAttribute('data-item-id');
    const data = await fetchJSON(`/api/items/${id}`);

    // set base fields
    editForm.action = `/container/{{ cont['id'] }}/items/${id}/update`;
    document.getElementById('editItemId').value = id;
    editName.value = data.item.name || '';
    editQty.value  = data.item.qty || 1;
    editNote.value = data.item.note || '';
    editTypeSel.value = data.item.type_id || '';

    // map dynamic values by field_id
    const valmap = {};
    (data.fields || []).forEach(f=>{ valmap[f.field_id] = f.value; });

    if(editTypeSel.value){
      const fields = await fetchJSON(`/api/item-types/${editTypeSel.value}/fields`);
      renderFields(editDynFields, fields, valmap);
    } else {
      editDynFields.innerHTML = '';
    }

    editItemModal.style.display = 'flex';
  }
  window.openEditItem = openEditItem;

  // change type on edit -> refetch fields
  if(editTypeSel){
    editTypeSel.addEventListener('change', async (e)=>{
      const tid = e.target.value;
      if(!tid){ editDynFields.innerHTML=''; return; }
      const fields = await fetchJSON(`/api/item-types/${tid}/fields`);
      renderFields(editDynFields, fields, {});
    });
  }

  // Esc closes modals
  window.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      if(addItemModal) addItemModal.style.display='none';
      if(editItemModal) editItemModal.style.display='none';
    }
  });
</script>

<script>
(() => {
  const btn  = document.getElementById('scanDestParentBtn');
  const form = document.getElementById('moveContainerForm');
  const sel  = document.getElementById('moveDestParentSelect');
  if (!btn || !form || !sel) return;

  btn.addEventListener('click', () => {
    // When a QR is scanned, we receive the CONTAINER id.
    // We fetch its parent shelf/drawer, set the select, and submit.
    window.qrScanHook = async (scannedContainerId) => {
      try {
        const r = await fetch(`/api/containers/${scannedContainerId}`);
        if (!r.ok) throw new Error('not-found');
        const data = await r.json();              // { id, parent_id, ... }
        const parentId = data.parent_id;
        if (!parentId) throw new Error('no-parent');

        let opt = sel.querySelector(`option[value="${parentId}"]`);
        if (!opt) {
          opt = document.createElement('option');
          opt.value = parentId;
          opt.textContent = `Scanned location ‚Ä¢ ${parentId}`;
          sel.prepend(opt);
        }
        sel.value = parentId;
        form.submit();
      } catch (e) {
        alert('Scanned container found, but could not resolve its location.');
        console.warn(e);
      } finally {
        window.qrScanHook = null;
        if (typeof window.closeQrScanner === 'function') window.closeQrScanner();
      }
    };

    // Open the global scanner
    if (typeof window.openQrScanner === 'function') {
      window.openQrScanner();
    } else {
      document.getElementById('scanQrMenu')?.click();
      document.getElementById('qrBtn')?.click();
    }
  });
})();
</script>




{% endblock %}
