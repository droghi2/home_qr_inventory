{% extends "base.html" %}
{% block content %}

<div class="section grid-2">
  <div class="col">

    <!-- Back rail + header card, aligned on the left -->
    <div class="section header-row-outside">
      <a class="back-rail" href="{% if parent %}/node/{{ parent['id'] }}{% else %}/{% endif %}" aria-label="Back" title="Back">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M15 18L9 12l6-6" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>

      <div class="card">
        <div class="card-pad">
          <div class="badges breadcrumb-inline">
            {# TOP LEVEL: Wardrobe/Cabinet first #}
            {% if top %}
              <a class="link crumb" href="/node/{{ top['id'] }}">{{ top['type'] }} ‚Äî {{ top['name'] }}</a>
              {% if top['note'] %}
                <span class="sep">‚Ä¢</span>
                <span class="note" title="{{ top['note'] }}">{{ top['note'] }}</span>
              {% endif %}
            {% endif %}

            {% if top or parent %}<span class="sep">‚Ä∫</span>{% endif %}

            {# PARENT SHELF/DRAWER next #}
            {% if parent %}
              <a class="link crumb" href="/node/{{ parent['id'] }}">{{ parent['type'] }} ‚Äî {{ parent['name'] }}</a>
              {% if parent['note'] %}
                <span class="sep">‚Ä¢</span>
                <span class="note" title="{{ parent['note'] }}">{{ parent['note'] }}</span>
              {% endif %}
              <span class="sep">‚Ä∫</span>
            {% endif %}

            {# CURRENT CONTAINER TYPE pill last (Box/Organizator/In Place) #}
            <span class="pill">{{ cont['type'] }}</span>
          </div>

          <div class="row" style="justify-content:space-between; align-items:center; margin-top:.3rem;">
            <h2 style="margin:.3rem 0 0 0">
              {{ cont['name'] }} <span class="muted">(#{{ cont['id'] }})</span>
            </h2>
            <form class="no-shrink" action="/container/{{ cont['id'] }}/delete" method="post"
                  data-ctype="{{ cont['type'] }}"
                  onsubmit="return confirmContainerDelete(this);">
              <button class="icon-btn danger" type="submit"
                      aria-label="Delete {{ cont['type'] }}" title="Delete {{ cont['type'] }}">üóëÔ∏è</button>
            </form>
          </div>

          {% if cont['note'] %}<div class="muted">{{ cont['note'] }}</div>{% endif %}
        </div>
      </div>
    </div>
    <!-- /Back rail + header -->

    <!-- Items (left column) -->
    <div class="section">
      <div class="row toolbar-mini" style="justify-content:space-between;">
        <h2 class="kicker" style="margin:0">Items</h2>
        <button type="button" class="icon-btn plus" id="addItemBtn" title="Add item">+</button>
      </div>

      <div class="card">
        <div class="card-pad">
          <ul class="list">
            {% for it in items %}
            <li>
              <div><strong>{{ it['name'] }}</strong> √ó {{ it['qty'] }}</div>
              {% if it['note'] %}<div class="muted">{{ it['note'] }}</div>{% endif %}
              <form action="/container/{{ cont['id'] }}/items/{{ it['id'] }}/delete" method="post" style="margin-left:auto">
                <button class="danger">Delete</button>
              </form>
            </li>
            {% else %}
            <li class="empty">No items yet.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

  </div>

  <!-- QR (right column) -->
  <aside class="col">
    <div class="section">
      <div class="card sticky">
        <div class="card-pad">
          <div class="badges"><span class="pill">QR label</span></div>
          <p class="muted" style="margin-top:.4rem">Scan to open this container.</p>
          <p style="display:grid; place-items:center; margin:.8rem 0;">
            <img src="/container/{{ cont['id'] }}/qr.png" alt="QR for this container" style="max-width:220px; width:100%; height:auto">
          </p>
          <form action="/container/{{ cont['id'] }}/qr/refresh" method="post" class="row" style="gap:8px; justify-content:center;">
            <button class="ghost" type="submit" title="Regenerate QR">Refresh QR</button>
            <a class="link" href="/container/{{ cont['id'] }}/qr.png" download>Download PNG</a>
          </form>
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- Modal: Add Item (blurred overlay) -->
<div id="addItemModal" class="modal modal-small">
  <div class="modal-content card">
    <div class="card-pad">
      <h2 class="kicker">Add item</h2>
      <form action="/container/{{ cont['id'] }}/items" method="post" class="stack">
        <label>Name
          <input required name="name" placeholder="e.g., Socks">
        </label>
        <label>Quantity
          <input type="number" min="1" value="1" name="qty">
        </label>
        <label>Note
          <input name="note" placeholder="optional">
        </label>
        <div class="row" style="gap:8px; justify-content:flex-end;">
          <button type="button" class="ghost" id="cancelItem">Cancel</button>
          <button class="primary" type="submit">Add</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function confirmContainerDelete(form){
    const t = (form.getAttribute('data-ctype') || 'container').toLowerCase();
    return confirm(`Delete this ${t} and all its items? This cannot be undone.`);
  }

  // Add Item modal controls
  const addItemBtn   = document.getElementById('addItemBtn');
  const addItemModal = document.getElementById('addItemModal');
  const cancelItem   = document.getElementById('cancelItem');

  if(addItemBtn){ addItemBtn.addEventListener('click', ()=> { addItemModal.style.display = 'flex'; }); }
  if(cancelItem){ cancelItem.addEventListener('click', ()=> { addItemModal.style.display = 'none'; }); }
  if(addItemModal){
    addItemModal.addEventListener('click', (e)=>{ if(e.target === addItemModal) addItemModal.style.display='none'; });
  }
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && addItemModal && addItemModal.style.display === 'flex'){
      addItemModal.style.display = 'none';
    }
  });
</script>

{% endblock %}
